{"version":3,"file":"livecheck.min.js","sources":["../src/livecheck.js"],"sourcesContent":["/**\n * Local plugin \"Maintenance mode (live check)\" - JS Code\n *\n * @module   local_maintenance_livecheck/livecheck\n * @copyright 2017 Alexander Bias, University of Ulm <alexander.bias@uni-ulm.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/str', 'core/log', 'core/config'], function($, str, log, config) {\n    \"use strict\";\n\n    // Global variable for left time.\n    var timeleftinsec = null;\n\n    // Global variable for countdown interval.\n    var countdownInterval = null;\n\n    // Global variable for maintenance announcement box content.\n    var boxContent = null;\n\n    /**\n     * Function which shows the maintenance announcement box.\n     */\n    function showBox() {\n        // If maintenance announcement box does not have content already.\n        if (boxContent === null) {\n            // Create the maintenance announcement box content and save it globally.\n            $('#maintenance_announcement').append('<div class=\"box py-3 moodle-has-zindex maintenancewarning alert\"' +\n                    'aria-live=\"polite\">');\n            boxContent = $('.box.maintenancewarning');\n        }\n    }\n\n    /**\n     * Function which hides the maintenance announcement box.\n     */\n    function hideBox() {\n        // If maintenance announcement box still has content.\n        if (boxContent !== null) {\n            // Remove the content and reset the box content's global variable.\n            $('#maintenance_announcement').empty();\n            boxContent = null;\n        }\n    }\n\n    /**\n     * This function fetches the necessary strings once and caches them locally in the browser.\n     * This is needed because we won't be able to get the sitemaintenance string anymore from the server as soon as\n     * maintenance mode has started.\n     */\n    function cacheStrings() {\n        str.get_strings([\n                {key: 'sitemaintenance', component: 'admin'},\n                {key: 'maintenancemodeisscheduled', component: 'admin'},\n                {key: 'maintenancemodeisscheduledlong', component: 'admin'}\n            ]);\n    }\n\n    /**\n     * Function to update the countdown in the maintenance announcement box.\n     */\n    function updateCountdown() {\n        // Reduce left time globally.\n        timeleftinsec -= 1;\n\n        // Maintenance mode has started.\n        if (timeleftinsec <= 0) {\n            str.get_string('sitemaintenance', 'admin').done(function(s) {\n                boxContent.html(s);\n            });\n\n            // Maintenance mode is still scheduled.\n        } else {\n            var a = {};\n            a.sec = Math.floor(timeleftinsec % 60);\n            a.min = Math.floor(timeleftinsec / 60) % 60;\n            a.hour = Math.floor(timeleftinsec / 3600);\n            if (a.hour > 0) {\n                str.get_string('maintenancemodeisscheduledlong', 'admin', a).done(function(s) {\n                    boxContent.html(s);\n                });\n            } else {\n                str.get_string('maintenancemodeisscheduled', 'admin', a).done(function(s) {\n                    boxContent.html(s);\n                });\n            }\n        }\n\n        // Set maintenance announcement box class to highlight the importance.\n        if (timeleftinsec < 30) {\n            boxContent.addClass('alert-error').addClass('alert-danger').removeClass('alert-warning');\n        } else {\n            boxContent.addClass('alert-warning').removeClass('alert-error').removeClass('alert-error');\n        }\n    }\n\n    /**\n     * Function which performs the continuous live check.\n     */\n    function checkStatus() {\n        // Fetch maintenance mode status by AJAX.\n        // We know about the benefits of the core/ajax module (https://docs.moodle.org/dev/AJAX),\n        // but for this very lightweight check we only use a simple jQuery AJAX call.\n        $.ajax({\n            url: config.wwwroot + '/local/maintenance_livecheck/ajax.php',\n            dataType: 'json',\n            type: 'POST',\n            data: {\n                // Add a query string to prevent older versions of IE from using the cache.\n                'time': Date.now()\n            },\n            headers: {\n                'Cache-Control': 'no-cache',\n                'Expires': '-1'\n            },\n            success: function(result) {\n                // If CLI maintenance mode is not scheduled or active.\n                if (result.timeleftinsec === null) {\n                    // Hide the maintenance announcement box.\n                    hideBox();\n\n                    // Clear the left time globally.\n                    timeleftinsec = null;\n\n                    // Stop the countdown interval.\n                    clearInterval(countdownInterval);\n\n                    // Otherwise, if CLI maintenance mode is scheduled.\n                } else if (result.timeleftinsec !== null && result.timeleftinsec > 0) {\n                    // Show the maintenance announcement box.\n                    showBox();\n\n                    // Store the left time globally.\n                    timeleftinsec = result.timeleftinsec;\n\n                    // Re-Start the countdown interval.\n                    clearInterval(countdownInterval);\n                    countdownInterval = setInterval(updateCountdown, 1000);\n\n                    // Otherwise, if legacy maintenance mode is active.\n                } else if (result.timeleftinsec !== null && result.timeleftinsec === 0) {\n                    // Show the maintenance announcement box.\n                    showBox();\n\n                    // Store the left time globally.\n                    timeleftinsec = 0;\n\n                    // Stop the countdown and run it once to show the sitemaintenance message.\n                    clearInterval(countdownInterval);\n                    updateCountdown();\n                }\n            },\n            error: function(request) {\n                // If CLI maintenance mode is active.\n                if (request.status == 503 && request.statusText == 'Moodle under maintenance') {\n                    // Show the maintenance announcement box.\n                    showBox();\n\n                    // Store the left time globally.\n                    timeleftinsec = 0;\n\n                    // Stop the countdown and run it once to show the sitemaintenance message.\n                    clearInterval(countdownInterval);\n                    updateCountdown();\n\n                    // The AJAX call was cached somewhere.\n                } else if (request.status >= 300 && request.status <= 399) {\n                    // Warn the developer.\n                    log.debug('moodle-local_maintenance_livecheck-livecheck: ' +\n                            'A cached copy of the live check answer was returned so it\\'s reliablity cannot be guaranteed. ' +\n                            'Hiding the maintenance announcement box now.');\n\n                    // Hide the maintenance announcement box.\n                    hideBox();\n\n                    // Clear the left time globally.\n                    timeleftinsec = null;\n\n                    // Stop the countdown interval.\n                    clearInterval(countdownInterval);\n                }\n            }\n        });\n    }\n\n    return {\n        init: function(params) {\n            // Initialize continuous live check.\n            if (params.checkinterval !== null && params.checkinterval > 0) {\n                // Add maintenance announcement box to page.\n                $('body').append('<div id=\"maintenance_announcement\">');\n\n                // If a back off time is set.\n                if (params.backoff !== null && params.backoff > 0) {\n                    // Wait params.backoff seconds and then check status every params.checkinterval seconds.\n                    setTimeout(function() {\n                        setInterval(checkStatus, params.checkinterval * 1000);\n                    }, params.backoff * 1000);\n\n                    // Otherwise if no back off time is set.\n                } else {\n                    // Check status every params.checkinterval seconds.\n                    setInterval(checkStatus, params.checkinterval * 1000);\n                }\n\n                // Cache strings in browser.\n                cacheStrings();\n            }\n        }\n    };\n});\n"],"names":["define","$","str","log","config","timeleftinsec","countdownInterval","boxContent","showBox","append","hideBox","empty","updateCountdown","get_string","done","s","html","a","sec","Math","floor","min","hour","addClass","removeClass","checkStatus","ajax","url","wwwroot","dataType","type","data","Date","now","headers","success","result","clearInterval","setInterval","error","request","status","statusText","debug","init","params","checkinterval","backoff","setTimeout","get_strings","key","component"],"mappings":";;;;;;;AAQAA,+CAAO,CAAC,SAAU,WAAY,WAAY,gBAAgB,SAASC,EAAGC,IAAKC,IAAKC,YAIxEC,cAAgB,KAGhBC,kBAAoB,KAGpBC,WAAa,cAKRC,UAEc,OAAfD,aAEAN,EAAE,6BAA6BQ,OAAO,uFAEtCF,WAAaN,EAAE,qCAOdS,UAEc,OAAfH,aAEAN,EAAE,6BAA6BU,QAC/BJ,WAAa,eAoBZK,sBAELP,eAAiB,IAGI,EACjBH,IAAIW,WAAW,kBAAmB,SAASC,MAAK,SAASC,GACrDR,WAAWS,KAAKD,UAIjB,KACCE,EAAI,GACRA,EAAEC,IAAMC,KAAKC,MAAMf,cAAgB,IACnCY,EAAEI,IAAMF,KAAKC,MAAMf,cAAgB,IAAM,GACzCY,EAAEK,KAAOH,KAAKC,MAAMf,cAAgB,MAChCY,EAAEK,KAAO,EACTpB,IAAIW,WAAW,iCAAkC,QAASI,GAAGH,MAAK,SAASC,GACvER,WAAWS,KAAKD,MAGpBb,IAAIW,WAAW,6BAA8B,QAASI,GAAGH,MAAK,SAASC,GACnER,WAAWS,KAAKD,MAMxBV,cAAgB,GAChBE,WAAWgB,SAAS,eAAeA,SAAS,gBAAgBC,YAAY,iBAExEjB,WAAWgB,SAAS,iBAAiBC,YAAY,eAAeA,YAAY,wBAO3EC,cAILxB,EAAEyB,KAAK,CACHC,IAAKvB,OAAOwB,QAAU,wCACtBC,SAAU,OACVC,KAAM,OACNC,KAAM,MAEMC,KAAKC,OAEjBC,QAAS,iBACY,mBACN,MAEfC,QAAS,SAASC,QAEe,OAAzBA,OAAO/B,eAEPK,UAGAL,cAAgB,KAGhBgC,cAAc/B,oBAGkB,OAAzB8B,OAAO/B,eAA0B+B,OAAO/B,cAAgB,GAE/DG,UAGAH,cAAgB+B,OAAO/B,cAGvBgC,cAAc/B,mBACdA,kBAAoBgC,YAAY1B,gBAAiB,MAGjB,OAAzBwB,OAAO/B,eAAmD,IAAzB+B,OAAO/B,gBAE/CG,UAGAH,cAAgB,EAGhBgC,cAAc/B,mBACdM,oBAGR2B,MAAO,SAASC,SAEU,KAAlBA,QAAQC,QAAuC,4BAAtBD,QAAQE,YAEjClC,UAGAH,cAAgB,EAGhBgC,cAAc/B,mBACdM,mBAGO4B,QAAQC,QAAU,KAAOD,QAAQC,QAAU,MAElDtC,IAAIwC,MAAM,2LAKVjC,UAGAL,cAAgB,KAGhBgC,cAAc/B,6BAMvB,CACHsC,KAAM,SAASC,QAEkB,OAAzBA,OAAOC,eAA0BD,OAAOC,cAAgB,IAExD7C,EAAE,QAAQQ,OAAO,uCAGM,OAAnBoC,OAAOE,SAAoBF,OAAOE,QAAU,EAE5CC,YAAW,WACPV,YAAYb,YAAoC,IAAvBoB,OAAOC,iBAChB,IAAjBD,OAAOE,SAKVT,YAAYb,YAAoC,IAAvBoB,OAAOC,eAvJ5C5C,IAAI+C,YAAY,CACR,CAACC,IAAK,kBAAmBC,UAAW,SACpC,CAACD,IAAK,6BAA8BC,UAAW,SAC/C,CAACD,IAAK,iCAAkCC,UAAW"}