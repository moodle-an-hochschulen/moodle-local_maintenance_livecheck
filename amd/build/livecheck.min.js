/**
 * Local plugin "Maintenance mode (live check)" - JS Code
 *
 * @module   local_maintenance_livecheck/livecheck
 * @copyright 2017 Alexander Bias, University of Ulm <alexander.bias@uni-ulm.de>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_maintenance_livecheck/livecheck",["jquery","core/str","core/log","core/config"],(function($,str,log,config){var timeleftinsec=null,countdownInterval=null,boxContent=null;function showBox(){null===boxContent&&($("#maintenance_announcement").append('<div class="box py-3 moodle-has-zindex maintenancewarning alert"aria-live="polite">'),boxContent=$(".box.maintenancewarning"))}function hideBox(){null!==boxContent&&($("#maintenance_announcement").empty(),boxContent=null)}function updateCountdown(){if((timeleftinsec-=1)<=0)str.get_string("sitemaintenance","admin").done((function(s){boxContent.html(s)}));else{var a={};a.sec=Math.floor(timeleftinsec%60),a.min=Math.floor(timeleftinsec/60)%60,a.hour=Math.floor(timeleftinsec/3600),a.hour>0?str.get_string("maintenancemodeisscheduledlong","admin",a).done((function(s){boxContent.html(s)})):str.get_string("maintenancemodeisscheduled","admin",a).done((function(s){boxContent.html(s)}))}timeleftinsec<30?boxContent.addClass("alert-error").addClass("alert-danger").removeClass("alert-warning"):boxContent.addClass("alert-warning").removeClass("alert-error").removeClass("alert-error")}function checkStatus(){$.ajax({url:config.wwwroot+"/local/maintenance_livecheck/ajax.php",dataType:"json",type:"POST",data:{time:Date.now()},headers:{"Cache-Control":"no-cache",Expires:"-1"},success:function(result){null===result.timeleftinsec?(hideBox(),timeleftinsec=null,clearInterval(countdownInterval)):null!==result.timeleftinsec&&result.timeleftinsec>0?(showBox(),timeleftinsec=result.timeleftinsec,clearInterval(countdownInterval),countdownInterval=setInterval(updateCountdown,1e3)):null!==result.timeleftinsec&&0===result.timeleftinsec&&(showBox(),timeleftinsec=0,clearInterval(countdownInterval),updateCountdown())},error:function(request){503==request.status&&"Moodle under maintenance"==request.statusText?(showBox(),timeleftinsec=0,clearInterval(countdownInterval),updateCountdown()):request.status>=300&&request.status<=399&&(log.debug("moodle-local_maintenance_livecheck-livecheck: A cached copy of the live check answer was returned so it's reliablity cannot be guaranteed. Hiding the maintenance announcement box now."),hideBox(),timeleftinsec=null,clearInterval(countdownInterval))}})}return{init:function(params){null!==params.checkinterval&&params.checkinterval>0&&($("body").append('<div id="maintenance_announcement">'),null!==params.backoff&&params.backoff>0?setTimeout((function(){setInterval(checkStatus,1e3*params.checkinterval)}),1e3*params.backoff):setInterval(checkStatus,1e3*params.checkinterval),str.get_strings([{key:"sitemaintenance",component:"admin"},{key:"maintenancemodeisscheduled",component:"admin"},{key:"maintenancemodeisscheduledlong",component:"admin"}]))}}}));

//# sourceMappingURL=livecheck.min.js.map